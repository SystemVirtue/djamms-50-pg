# MAGIC LINK 404 FIX - COMPLETE SOLUTION

## Problem

Magic link emails contain wrong URL:
```
Actual:   https://djamms.app/auth/callback?secret=...
Expected: https://auth.djamms.app/callback?secret=...
```

Result: **404 NOT_FOUND** when clicking magic link

## Root Cause Analysis

The redirect URL comes from build-time environment variable `VITE_APPWRITE_MAGIC_REDIRECT`.

When this variable is **not set in Vercel at build time**, the code falls back to:
```typescript
window.location.origin + '/auth/callback'
```

This fallback is creating the wrong URL because:
1. The origin might be the root domain during build
2. It's adding `/auth/callback` instead of just `/callback`

## Two Separate Fixes Needed

### Fix 1: Update Vercel Environment Variable (CRITICAL)

The frontend auth app needs the correct redirect URL set at **build time**.

#### Steps:

1. **Go to Vercel Dashboard**:
   - https://vercel.com/dashboard
   - Find your `djamms-auth` project (or whatever it's called)

2. **Go to Settings → Environment Variables**

3. **Add or Update Variable**:
   ```
   Name:  VITE_APPWRITE_MAGIC_REDIRECT
   Value: https://auth.djamms.app/callback
   ```
   
   ⚠️ **IMPORTANT**: Make sure it's `https://auth.djamms.app/callback` (NOT `/auth/callback`)

4. **Select Environment**:
   - ✅ Production
   - ✅ Preview  
   - ✅ Development

5. **Click Save**

6. **Redeploy**:
   - Go to **Deployments** tab
   - Click **⋯** (three dots) on latest deployment
   - Click **Redeploy**
   - Wait for build to complete

### Fix 2: Update Code Fallback (RECOMMENDED)

Even with the environment variable set, the fallback logic is wrong. Let's fix it:

**File**: `/packages/shared/src/config/env.ts`

**Current code (lines 29-30)**:
```typescript
magicLinkRedirect: import.meta.env.VITE_APPWRITE_MAGIC_REDIRECT || 
  (typeof window !== 'undefined' ? `${window.location.origin}/auth/callback` : ''),
```

**Should be**:
```typescript
magicLinkRedirect: import.meta.env.VITE_APPWRITE_MAGIC_REDIRECT || 
  (typeof window !== 'undefined' ? `${window.location.origin}/callback` : ''),
```

**Change**: Remove `/auth` prefix from fallback URL

This ensures even if the environment variable is missing, it will still generate the correct path.

## Testing After Fix

1. **Clear your browser cache** (important!)

2. **Request new magic link**:
   - Go to https://auth.djamms.app
   - Enter your email
   - Click "Send Magic Link"

3. **Check email**:
   - Open the email
   - **Verify URL** shows: `https://auth.djamms.app/callback?secret=...`
   - NOT `https://djamms.app/auth/callback...`

4. **Click link**:
   - Should redirect to auth callback page
   - Should authenticate successfully
   - Should redirect to player/dashboard
   - **NO 404 ERROR**

## Why This Happened

1. **Wrong Domain**: The email URL shows `djamms.app` instead of `auth.djamms.app`
   - This suggests the `VITE_APPWRITE_MAGIC_REDIRECT` variable was not set in Vercel
   - Or it was set to the wrong domain

2. **Wrong Path**: The URL has `/auth/callback` instead of `/callback`
   - This comes from the fallback code in `env.ts`
   - The fallback adds `/auth` prefix which doesn't exist

3. **Why didn't updating Porkbun fix it?**
   - Porkbun DNS has nothing to do with this issue
   - This is about the environment variable in Vercel
   - The magic link URL is generated by the frontend code at build time

## Verification Commands

After making changes, verify:

```bash
# 1. Check local .env is correct
grep VITE_APPWRITE_MAGIC_REDIRECT .env
# Should show: https://auth.djamms.app/callback

# 2. After Vercel redeploy, check the live site
curl -s https://auth.djamms.app | grep -o 'callback'
# Should see "callback" (not "auth/callback")

# 3. Test magic link generation
# Request a magic link and check the email
```

## Quick Fix Checklist

- [ ] Update Vercel environment variable `VITE_APPWRITE_MAGIC_REDIRECT`
- [ ] Set value to: `https://auth.djamms.app/callback`
- [ ] Apply to Production, Preview, and Development
- [ ] Save changes
- [ ] Redeploy the auth app
- [ ] Wait for deployment to complete
- [ ] Clear browser cache
- [ ] Request new magic link
- [ ] Verify email contains correct URL
- [ ] Click link and verify successful authentication

## Additional Fix (Code Improvement)

To prevent this from happening again, update the fallback:

```bash
# Edit packages/shared/src/config/env.ts
# Change line 30 from:
#   (typeof window !== 'undefined' ? `${window.location.origin}/auth/callback` : ''),
# To:
#   (typeof window !== 'undefined' ? `${window.location.origin}/callback` : ''),
```

Then commit and push:

```bash
git add packages/shared/src/config/env.ts
git commit -m "Fix magic link redirect fallback path"
git push origin main
```

## Why Environment Variable vs Code Fix

**Environment Variable** (Fix 1):
- ✅ Immediate fix
- ✅ No code changes needed
- ✅ Controls behavior per environment
- ⚠️ Must be set correctly in Vercel

**Code Fix** (Fix 2):
- ✅ Better fallback behavior
- ✅ Prevents future issues
- ✅ Works even if env var missing
- ⚠️ Requires redeploy

**Both together** = Most robust solution!

## Expected Result

After both fixes:

1. **Email URL**: `https://auth.djamms.app/callback?secret=6130286dbb556f4b...&userId=mike.clarkin@gmail.com`
2. **Click link**: Redirects to callback page
3. **Callback page**: Verifies token, issues JWT, stores in localStorage
4. **Final redirect**: Takes you to player or dashboard
5. **Status**: ✅ Authenticated successfully

## Files to Edit

1. **Vercel Dashboard** (manual):
   - Environment Variables for `djamms-auth` project
   - Add `VITE_APPWRITE_MAGIC_REDIRECT=https://auth.djamms.app/callback`

2. **packages/shared/src/config/env.ts** (code):
   - Line 30: Remove `/auth` prefix from fallback
   - Change `/auth/callback` to `/callback`

## Related Documentation

- Local .env configuration: `/.env`
- Auth service code: `/packages/appwrite-client/src/auth.ts`
- Config file: `/packages/shared/src/config/env.ts`
- Callback handler: `/apps/auth/src/components/AuthCallback.tsx`
