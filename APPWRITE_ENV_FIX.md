# Fix Magic Link Callback URL - Appwrite Environment Variables

## Problem

Magic link emails contain wrong URL:
```
Current:  https://djamms.app/auth/callback?secret=...
Should be: https://auth.djamms.app/callback?secret=...
```

## Root Cause

The magic link URL is generated by the **Appwrite Cloud Function** (`magic-link`), NOT by your Vercel-deployed frontend.

The function reads `process.env.VITE_APPWRITE_MAGIC_REDIRECT`, which is set in **Appwrite Console**, not in Vercel.

## Solution: Update Appwrite Function Environment Variables

### Step 1: Go to Appwrite Console

1. Open: https://cloud.appwrite.io/console/project-68cc86c3002b27e13947
2. Click **Functions** in left sidebar
3. Click **magic-link** function (ID: `68e5a317003c42c8bb6a`)

### Step 2: Update Environment Variables

1. Click **Settings** tab
2. Scroll to **Environment Variables** section
3. Look for `VITE_APPWRITE_MAGIC_REDIRECT`

**Option A: If variable exists**
- Click **Edit** (pencil icon)
- Change value to: `https://auth.djamms.app/callback`
- Click **Update**

**Option B: If variable doesn't exist**
- Click **Add Variable**
- Key: `VITE_APPWRITE_MAGIC_REDIRECT`
- Value: `https://auth.djamms.app/callback`
- Click **Create**

### Step 3: Redeploy Function

After updating the environment variable:

1. Go to **Deployments** tab
2. Click **Redeploy** on the latest deployment
3. Wait for deployment to complete (should take 1-2 minutes)

### Step 4: Test

1. Go to https://auth.djamms.app
2. Request a new magic link
3. Check your email
4. **Verify URL is correct**: `https://auth.djamms.app/callback?secret=...`
5. Click the link
6. Should redirect successfully (no 404)

## Why This Happens

The magic link email is sent by the Appwrite Cloud Function:

```javascript
// functions/appwrite/src/magic-link.js line 28
redirectUrl: redirectUrl || process.env.VITE_APPWRITE_MAGIC_REDIRECT
```

This function runs on **Appwrite's servers**, not on Vercel, so it uses environment variables from **Appwrite Console**, not from Vercel.

## Current Environment Variable Configuration

### ✅ Correct (Local .env)
```
VITE_APPWRITE_MAGIC_REDIRECT=https://auth.djamms.app/callback
```

### ⚠️ Unknown (Appwrite Console - Need to Check/Update)
```
VITE_APPWRITE_MAGIC_REDIRECT=???
```

The Appwrite function is probably using an old value or falling back to a default that includes the wrong domain.

## Verification Checklist

After making the change:

- [ ] Environment variable updated in Appwrite Console
- [ ] Function redeployed
- [ ] New magic link email requested
- [ ] Email contains correct URL: `https://auth.djamms.app/callback?secret=...`
- [ ] Clicking link works (no 404)
- [ ] Successfully authenticates and redirects

## Additional Notes

### Function Environment Variables vs Project Variables

Appwrite has two types of environment variables:
1. **Project-level variables** (global, like `RESEND_API_KEY`)
2. **Function-level variables** (specific to each function)

For the magic link redirect URL, you need to set it at the **function level** because it's specific to the magic-link function.

### Why Vercel Environment Variables Don't Apply

Vercel environment variables only affect code running on Vercel (your frontend apps). The magic link function runs on Appwrite's servers, so it only sees environment variables configured in Appwrite Console.

## Quick Fix Command

If you want to automate this in the future, you can use the Appwrite CLI:

```bash
# Install Appwrite CLI
npm install -g appwrite-cli

# Login
appwrite login

# Update function environment variable
appwrite functions updateVariable \
  --functionId 68e5a317003c42c8bb6a \
  --key VITE_APPWRITE_MAGIC_REDIRECT \
  --value "https://auth.djamms.app/callback"

# Redeploy function
appwrite functions createDeployment \
  --functionId 68e5a317003c42c8bb6a
```

## Related Files

- Function code: `/functions/appwrite/src/magic-link.js`
- Local env: `/.env` (correct value)
- This is where the redirect URL is read: line 28 in magic-link.js
